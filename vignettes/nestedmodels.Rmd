---
title: "nestedmodels"
description: "An introduction to the nestedmodels package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nestedmodels}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette provides an introduction to the nestedmodels package and the most
basic use case. For this and all other vignettes, it is assumed that you have a familiarity with the '[tidymodels](https://www.tidymodels.org)' framework (e.g. by reading [Tidy Modelling with R](https://www.tmwr.org)). This vignette, along with the others in this package, does not aim to teach good statistical practices, and instead demonstrates how to use the package as simply as possible, assuming that the way you use the package will be informed by other, better sources.

# What is nestedmodels?
nestedmodels is an extension to the '[tidymodels](https://www.tidymodels.org)' framework. It allows models and workflows to be used on [nested data](https://tidyr.tidyverse.org/articles/nest.html). It provides an alternative to [modeltime's approach to nested modelling](https://business-science.github.io/modeltime/articles/nested-forecasting.html) or the '[multilevelmod](https://multilevelmod.tidymodels.org)' package, allowing any model or workflow to be used on nested data very easily.

# Why do I need nestedmodels?
The best example where you may need to use the nestedmodels package is when working with [panel data](https://wikipedia.org/wiki/Panel_data). When you have a set of timeseries, each describing a different object (the historic prices for a set of stocks, for example), you may want to model each timeseries separately, especially considering the fact that many timeseries modelling tools do not work well with non-date predictors (and furthermore, many models do not accept non-numeric predictors, although there are often better ways to deal with this problem; see `recipes::step_dummy()`). In this scenario, nested modelling is often the best solution.

# How does nestedmodels work?
The implementation of nestedmodels is very simple. Fitting a nested model fits the model to each nested value (for timeseries about a set of stocks, a model would be fitted to each stock). The correct model will then be selected and used when making predictions.

# A quick example
In this vignette, we're going to explore the most basic example of a nested model. You're going to need the following packages:

```{r setup, include = FALSE}
library(nestedmodels)
library(tidymodels)
library(glmnet)
```

We're going to use the example data included in the 'nestedmodels' package. The data is very very simple, and only serves as an example of data that can be nested, rather than representing anything concrete.

```{r data}
data("example_nested_data")
data <- example_nested_data
data
```

The data can be nested. If we're going to manually nest the data before modelling it, we need to create a nested column named 'data'.

```{r nested_data}
nested_data <- nest(data, data = -id)
nested_data
```

Now let's define our model:

```{r create_model}
model <- linear_reg() %>%
  set_engine("glmnet")
```

Since we're fitting this model to nested data, we need some way to make the model 'nested'. This is very simple with the `nested()` function.

```{r nested_model}
nested_model <- model %>%
  nested()
nested_model
```

We can then fit this model in the usual way:

```{r fit_nested_model}
model_fit <- fit(model, z ~ ., nested_data)
```

Predicting can also be done in the usual way (note that to make predictions, the data must be nested). Since this is just a demonstration, we use the same data that the model was fitted on.

```{r predict_nested_model}
predict(model_fit, nested_data)
```

This method is fine, but having to nest the data ourselves is a pain. We can solve this by using a workflow.

We first define the recipe, and we define a step which is used to nest the data. We can see that the format is very similar to `tidyr::nest()`:

```{r recipe}
recipe <- recipe(data, z ~ .) %>%
  step_nest(-id)
```

This is a little easier than nesting the data manually.

```{r bake}
recipe %>%
  prep() %>%
  bake(NULL)
```

Now we create the workflow. There are several ways to create a nested workflow (see `nested_workflow()`), but we'll use `add_nested_model()`.

```{r workflow}
wf <- workflow() %>%
  add_nested_model(model) %>%
  add_recipe(recipe)
```

A workflow can be fitted in the same way as a model, but note that since we used `step_nest()` the data does not have to be nested.

```{r workflow_fit}
wf_fit <- fit(wf, data)
```

This fit object can then be used to make predictions. Again, the data does not have to be nested.

```{r}
predict(wf_fit, data)
```

Other methods can also be used on fitted nested models:

```{r}
augment(wf_fit, data)
tidy(wf_fit)
glance(wf_fit)
```

That's pretty much it as far as the basics are concerned. nestedmodels has a lot more functionality to offer, however, and I would recommend reading the other vignettes to learn the processes in more detail.

# Conclusion
In this short vignette, a simple example of a nested model and workflow were created and used on dummy data, to demonstrate how nestedmodels is used.
